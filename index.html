<!doctype html>
<html manifest="cache.appcache">
  <head>
    <title>Clock</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#303F9F">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon_128x128.png">
    <meta name="application-name" content="Clock">
    
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Weather PWA">
  <link rel="apple-touch-icon-precomposed" href="icon_152x152.png">
  <link rel="apple-touch-icon" href="icon_152x152.png">

  <meta name="msapplication-TileImage" content="icon_144x144.png">
  <meta name="msapplication-TileColor" content="#2F3BA2">    
    
	<style>svg { position:fixed; top:0; bottom:0; left:0; right:0 }</style>
  </head>
  <body id="xxx">
  </body>
  
  <script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker
             .register('service-worker.js')
             .then(function() { console.log('Service Worker Registered'); });
  }         
      
clocks = ["clock4.svg", "clock5.svg", "clock6.svg"]
clock_idx = localStorage.clock_idx || 0
modes = [{
   day_hours: 24,
   num_hours: 12,
   num_minutes: 60,
   offset: 0,
}, {
   day_hours: 10,
   num_hours: 10,
   num_minutes: 100,
   offset: 0,
}, {
   offset: 4/24,
   day_hours: 24,
   num_hours: 8,
   num_minutes: 64,
}
]
mode_idx = localStorage.mode_idx || 0
var timer_id = undefined


function readTextFile(file)
{
    var rawFile = new XMLHttpRequest();
    rawFile.open("GET", file, false);
    rawFile.onreadystatechange = function ()
    {
        if(rawFile.readyState === 4)
        {
            if(rawFile.status === 200 || rawFile.status == 0)
            {
                initialize(rawFile.responseText)
            }
        }
    }
    rawFile.send(null);
}    
    
function initialize(text) {
  if(timer_id !== undefined) {
     window.clearInterval(timer_id)
  }
  var ddiv = document.getElementById("xxx")
  ddiv.innerHTML = text
  
  var cXY = ",83.691625, 82.5)"
  var mode = modes[mode_idx]
  var mark = document.getElementById("mark_1")
  for(var i=1;i<mode.num_minutes;i++) {
      if(Math.abs((i*mode.num_hours/mode.num_minutes)%1)>1e-7) {
         var mark2 = mark.cloneNode(true)
         mark2.setAttribute("transform", "rotate("+(i*360/mode.num_minutes)+cXY)
         mark.parentNode.insertBefore(mark2, mark)
      }
  }
  mark.parentNode.removeChild(mark)
  var mark = document.getElementById("mark_2")
  var digits = document.getElementById("digits")
  digits.textContent = "" + mode.num_hours
  var h = digits.getExtentOfChar(0).height
  console.log(h)
  digits.setAttribute("x", 83.691625)
  digits.setAttribute("y", 82.5 - 50 + 0.25 * h)
  for(var i=1;i<mode.num_hours;i++) {
      var mark2 = mark.cloneNode(true)
      mark2.setAttribute("transform", "rotate("+(i*360/mode.num_hours)+cXY)
      mark.parentNode.insertBefore(mark2, mark)
      var digits2 = digits.cloneNode(true)
      digits2.setAttribute("x", 83.691625 + 50 * Math.sin(i*2*Math.PI/mode.num_hours))
      digits2.setAttribute("y", 82.5 - 50 * Math.cos(i*2*Math.PI/mode.num_hours) + 0.25 * h)
      digits2.textContent = ""+i
      digits.parentNode.insertBefore(digits2, digits)
  }
  function update() {
      var currentdate = new Date();
      var time = (currentdate.getMilliseconds()*0.001 + currentdate.getSeconds() + 60 * (currentdate.getMinutes() + 60 * currentdate.getHours()))/(3600*24) - mode.offset
      var deg = 360 * time * mode.day_hours / mode.num_hours
      var cc = document.getElementById("hours_hand")
      cc.setAttribute("transform", "rotate("+deg+cXY)
      time = (time * mode.day_hours) % 1
      deg = 360 * time
      cc = document.getElementById("minutes_hand")
      cc.setAttribute("transform", "rotate("+deg+cXY)
      time = (time * mode.num_minutes) % i
      deg = 360 * time
      cc = document.getElementById("seconds_hand")
      cc.setAttribute("transform", "rotate("+deg+cXY)
  }

  timer_id = window.setInterval(update, 100)
  update()
} 

readTextFile(clocks[clock_idx])

document.addEventListener('touchstart', handleTouchStart, false);        
document.addEventListener('touchmove', handleTouchMove, false);

var xDown = null;                                                        
var yDown = null;                                                        

function handleTouchStart(evt) {                                         
    xDown = evt.touches[0].clientX;                                      
    yDown = evt.touches[0].clientY;                                      
};                                                

function handleTouchMove(evt) {
    if ( ! xDown || ! yDown ) {
        return;
    }

    var xUp = evt.touches[0].clientX;                                    
    var yUp = evt.touches[0].clientY;

    var xDiff = xDown - xUp;
    var yDiff = yDown - yUp;

    if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
        if ( xDiff > 0 ) {
          clock_idx -= 1
          if(clock_idx < 0) clock_idx = clocks.length - 1
        } else {
          clock_idx += 1
          if(clock_idx >= clocks.length) clock_idx = 0
        }
        localStorage.clock_idx = clock_idx  
        readTextFile(clocks[clock_idx])
    } else {
        if ( yDiff > 0 ) {
          mode_idx -= 1
          if(mode_idx < 0) mode_idx = modes.length - 1
        } else {
          mode_idx += 1
          if(mode_idx >= modes.length) mode_idx = 0
        }
        localStorage.mode_idx = mode_idx
        readTextFile(clocks[clock_idx])
    }
    /* reset values */
    xDown = null;
    yDown = null;                                             
};
  </script>
  
  
</html>
